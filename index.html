<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaagrukVoter - Clear Ballot India</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        html {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0ea5e9;
            /* sky-500 */
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* New styles for AI-generated headings */
        #summaryOutput h3 {
            @apply text-xl font-bold text-sky-800 mt-5 mb-2 border-b-2 border-sky-100 pb-1;
        }

        #summaryOutput p {
            @apply mb-4 text-gray-800;
        }
    </style>
</head>

<body class="bg-sky-100 text-gray-900 min-h-screen">
    <div class="container mx-auto max-w-3xl p-4 pt-8 md:pt-12">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-800">JaagrukVoter</h1>
            <p class="text-lg text-gray-800 mt-2">Get clear, unbiased facts on candidates & policies.</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search Query -->
                <div class="md:col-span-2">
                    <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-1">Enter Candidate, Party, or Policy</label>
                    <input type="text" id="searchQuery"
                        class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                        placeholder="e.g., 'Candidate Name', 'Education Policy in Delhi'">
                </div>

                <!-- Language Selection -->
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                    <select id="language"
                        class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        <option value="English">English</option>
                        <option value="Hindi">Hindi (हिन्दी)</option>
                        <option value="Kannada">Kannada (ಕನ್ನಡ)</option>
                        <option value="Tamil">Tamil (தமிழ்)</option>
                        <option value="Telugu">Telugu (తెలుగు)</option>
                    </select>
                </div>
            </div>

            <!-- API Key Input -->
            <div class="mt-4">
                <label for="perplexityApiKey" class="block text-sm font-medium text-gray-700 mb-1">Perplexity API Key</label>
                <input type="password" id="perplexityApiKey"
                    class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                    placeholder="Enter your Perplexity API Key">
                <p class="text-xs text-gray-500 mt-1">Get a key from the Perplexity API dashboard. Your key is not stored.</p>
            </div>

            <!-- Analyze Button -->
            <div class="mt-6 text-center">
                <button id="analyzeButton"
                    class="w-full md:w-auto bg-gradient-to-r from-sky-600 to-sky-700 text-white font-semibold py-3 px-8 rounded-md hover:from-sky-700 hover:to-sky-800 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    Analyze
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center py-10" style="display: none;">
            <div class="spinner"></div>
            <p class="ml-4 text-gray-600">Finding and summarizing verified facts...</p>
        </div>

        <!-- Error Message -->
        <div id="error"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6"
            role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="errorMessage"></span>
        </div>

        <!-- Results Section -->
        <div id="results" class="bg-white rounded-lg shadow-lg" style="display: none;">
            <!-- Tabs -->
            <div class="border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <nav class="flex -mb-px px-6" aria-label="Tabs">
                    <button id="tab-summary"
                        class="tab-button w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-sky-600 border-sky-500"
                        aria-current="page">
                        Unbiased Summary
                    </button>
                    <button id="tab-sources"
                        class="tab-button w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Verified Sources
                    </button>
                </nav>
            </div>

            <!-- Summary Content -->
            <div id="content-summary" class="p-6 md:p-8">
                <h3 class="text-2xl font-bold mb-4 text-sky-800">Fact-Based Summary</h3>
                <div id="summaryOutput" class="prose prose-lg max-w-none text-gray-700">
                    <!-- AI-generated summary will be injected here -->
                </div>
            </div>

            <!-- Sources Content -->
            <div id="content-sources" class="p-6 md:p-8" style="display: none;">
                <h3 class="text-2xl font-bold mb-4 text-sky-800">Information Sources</h3>
                <p class="text-sm text-gray-600 mb-4">This summary was generated using facts from the following verified
                    public sources:</p>
                <ul id="sourcesOutput" class="list-disc pl-5 space-y-2">
                    <!-- Verified sources will be injected here -->
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const analyzeButton = document.getElementById('analyzeButton');
            const searchQuery = document.getElementById('searchQuery');
            const language = document.getElementById('language');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');

            // Tabs
            const tabSummary = document.getElementById('tab-summary');
            const tabSources = document.getElementById('tab-sources');
            const contentSummary = document.getElementById('content-summary');
            const contentSources = document.getElementById('content-sources');

            const summaryOutput = document.getElementById('summaryOutput');
            const sourcesOutput = document.getElementById('sourcesOutput');

            // Tab switching logic
            tabSummary.addEventListener('click', () => {
                contentSummary.style.display = 'block';
                contentSources.style.display = 'none';
                tabSummary.classList.add('text-sky-600', 'border-sky-500');
                tabSummary.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                tabSources.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                tabSources.classList.remove('text-sky-600', 'border-sky-500');
            });

            tabSources.addEventListener('click', () => {
                contentSummary.style.display = 'none';
                contentSources.style.display = 'block';
                tabSources.classList.add('text-sky-600', 'border-sky-500');
                tabSources.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                tabSummary.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                tabSummary.classList.remove('text-sky-600', 'border-sky-500');
            });

            // Main analyze button click handler
            analyzeButton.addEventListener('click', () => {
                const query = searchQuery.value;
                const lang = language.value;
                const apiKey = document.getElementById('perplexityApiKey').value;

                if (!query.trim()) {
                    showError('Please enter a search term.');
                    return;
                }
                
                if (!apiKey.trim()) {
                    showError('Please enter your Perplexity API Key.');
                    return;
                }

                // Reset UI
                loading.style.display = 'flex';
                results.style.display = 'none';
                error.style.display = 'none';
                summaryOutput.innerHTML = '';
                sourcesOutput.innerHTML = '';

                // Call the Perplexity API
                callPerplexityAPI(query, lang, apiKey);
            });

            /**
             * Shows an error message in the UI.
             * @param {string} message - The error message to display.
             */
            function showError(message) {
                errorMessage.textContent = message;
                error.style.display = 'block';
                loading.style.display = 'none';
                results.style.display = 'none';
            }

            /**
             * Calls the Perplexity API with the user's query and language.
             * @param {string} query - The user's search query.
             * @param {string} lang - The selected output language.
             * @param {string} apiKey - The user's Perplexity API key.
             */
            async function callPerplexityAPI(query, lang, apiKey) {
                // This is the core instruction for the AI, fulfilling Problem Statement 3
                const systemPrompt = `You are a non-partisan AI assistant for Indian voters ('JaagrukVoter'). Your purpose is to provide clear, simple, and strictly factual explanations about political candidates, parties, and policies in India.
- Your response MUST be non-partisan and unbiased. Do not express opinions or take sides.
- Stick to verifiable facts.
- Convert complex political and policy information into simple, easy-to-understand explanations.
- If analyzing media narratives, gently flag potential bias indicators (e.g., "This report uses strong emotional language" or "This article focuses heavily on one viewpoint") without accusing the source of 'bias'.
- Your final response MUST be in ${lang}.
- Do not make up information. If facts are not available, state that.
- You MUST structure your response with Markdown headings for each section.`;

                const userQuery = `Using verified public information, please provide a non-partisan analysis of: "${query}".
Structure your response with the following sections, using Markdown headings (e.g., "### General Summary"):

1. ### General Summary
   (Provide their party, key positions held if a candidate. Explain what it aims to do if a policy. Describe core ideology if a party.)

2. ### Public Record & Background
   (Detail professional background, political history, and any widely reported public records of legal cases or criminal charges, stated factually and neutrally.)

3. ### Key Policy Stances / Platform
   (List 3-5 key policy positions or platform points.)

4. ### Neutral Analysis of Media/Public Narrative
   (Gently flag potential bias indicators in common media narratives, e.g., "This report uses strong emotional language". If not applicable, state so.)

Keep the language simple and neutral. If a section is not applicable or no information is found, clearly state "No public information found for this section." under the heading.`;

                const apiUrl = "https://api.perplexity.ai/chat/completions";

                const payload = {
                    model: "sonar-pro", // Switched to the standard 'sonar-pro' online model
                    messages: [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: userQuery
                        }
                    ]
                };

                try {
                    // Implement fetch with exponential backoff for retries
                    const response = await fetchWithRetry(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Try to get more detailed error from the API response body
                        let errorDetails = `API Error: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            // Perplexity/OpenAI errors often have this structure
                            if (errorData.error && errorData.error.message) {
                                errorDetails = `API Error: ${errorData.error.message}`;
                            } else {
                                errorDetails = `API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`;
                            }
                        } catch (e) {
                            // Failed to parse JSON body, stick with original error
                        }
                        throw new Error(errorDetails);
                    }

                    const result = await response.json();
                    
                    if (!result.choices || !result.choices[0] || !result.choices[0].message || !result.choices[0].message.content) {
                        throw new Error("Invalid response structure from API.");
                    }

                    // 1. Get the generated text
                    const generatedText = result.choices[0].message.content;

                    // 2. Get the grounding sources from Perplexity's response
                    let sources = [];
                    if (result.search_results && result.search_results.length > 0) {
                        sources = result.search_results.map(source => ({
                            uri: source.url, // Perplexity uses 'url'
                            title: source.title
                        })).filter(source => source.uri && source.title); // Ensure sources are valid
                    }
                    
                    // Hide loading and display results
                    loading.style.display = 'none';
                    displayResults(generatedText, sources);

                } catch (err) {
                    console.error("Error in callPerplexityAPI:", err);
                    // Pass the more detailed error message to the UI
                    showError(err.message);
                }
            }

            /**
             * Populates the UI with the results from the API.
             * @param {string} summary - The AI-generated summary text.
             * @param {Array} sources - An array of source objects {uri, title}.
             */
            function displayResults(summary, sources) {
                // Simple Markdown-to-HTML (replaces newlines with <br>)
                summaryOutput.innerHTML = simpleMarkdownToHTML(summary);

                if (sources.length > 0) {
                    sourcesOutput.innerHTML = ''; // Clear any old sources
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = source.uri;
                        a.textContent = source.title;
                        a.target = '_blank'; // Open in new tab
                        a.rel = 'noopener noreferrer';
                        a.className = 'text-sky-600 hover:text-sky-800 hover:underline';
                        li.appendChild(a);
                        sourcesOutput.appendChild(li);
                    });
                } else {
                    sourcesOutput.innerHTML = '<li>No public sources were cited for this summary.</li>';
                }

                results.style.display = 'block';
                // Default to summary tab
                tabSummary.click();
            }

            /**
             * A simple markdown-to-HTML converter.
             * Handles ### headings and newlines.
             * @param {string} text - The markdown text from the AI.
             * @returns {string} - The converted HTML.
             */
            function simpleMarkdownToHTML(text) {
                // 1. Split the whole text by double newlines to get "blocks"
                return text.split('\n\n').map(block => {
                    block = block.trim(); // Clean up whitespace

                    if (block.startsWith('### ')) {
                        // It's a heading
                        return `<h3>${block.substring(4)}</h3>`;
                    } else if (block.length > 0) {
                        // It's a paragraph. Replace single newlines with <br> for line breaks within a paragraph.
                        return `<p>${block.replace(/\n/g, '<br>')}</p>`;
                    }
                    return ''; // Ignore empty blocks
                }).join('');
            }

            /**
             * A fetch wrapper with exponential backoff retry logic.
             * @param {string} url - The API URL.
             * @param {object} options - The fetch options (method, headers, body).
             * @param {number} retries - Number of retries.
             * @param {number} backoff - Initial backoff delay in ms.
             * @returns {Promise<Response>}
             */
            async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
                let lastError;
                for (let i = 0; i < retries; i++) {
                    try {
                        const res = await fetch(url, options);
                        if (res.ok) {
                            return res;
                        }
                        // Only retry on server errors or rate limiting
                        if (res.status === 429 || res.status >= 500) {
                            throw new Error(`Retryable error: ${res.status}`);
                        } else {
                            // Don't retry on client errors (e.g., 400 Bad Request)
                            return res;
                        }
                    } catch (err) {
                        lastError = err;
                        // Don't log retries to console as per instructions
                        await new Promise(resolve => setTimeout(resolve, backoff * Math.pow(2, i)));
                    }
                }
                throw lastError;
            }

        });
    </script>
</body>

</html>